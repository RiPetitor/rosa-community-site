+++
title = "Диагностика и устранение неисправностей"
description = "Решение распространённых проблем с драйверами NVIDIA"
weight = 4
+++

{{ doc_dates() }}

Иногда после установки или обновления системы с драйверами NVIDIA могут возникнуть проблемы. Вот как их диагностировать и решить.

## 1. Первичная диагностика

Прежде чем что-то менять, соберите информацию о системе.

### Проверка статуса драйвера

Основная команда для проверки работы драйвера:

```bash
nvidia-smi
```

Если она выводит таблицу с информацией о видеокарте, значит, драйвер работает. Если вы видите ошибку `NVIDIA-SMI has failed because it couldn't communicate with the NVIDIA driver`, значит, модуль ядра NVIDIA не загружен.

### Проверка статуса DKMS

DKMS (Dynamic Kernel Module Support) отвечает за автоматическую пересборку модуля драйвера при обновлении ядра.

```bash
dkms status
```

В выводе вы должны увидеть строчку `nvidia/ВЕРСИЯ, ЯДРО: installed`. Если статус `built` или `failed`, значит, модуль не установлен для текущего ядра.

### Проверка загруженных модулей

Убедитесь, что модуль `nvidia` загружен, а `nouveau` (открытый драйвер) — нет.

```bash
# Должен показать модуль nvidia
lsmod | grep nvidia

# Не должен ничего показывать
lsmod | grep nouveau
```
Если `nouveau` присутствует, он конфликтует с проприетарным драйвером.

## 2. Распространённые проблемы и решения

### Проблема: `nvidia-smi` не работает после обновления ядра

**Причина:** DKMS не смог пересобрать модуль для нового ядра.

**Решение:**

1.  Убедитесь, что у вас установлены заголовочные файлы для **текущего** ядра:
    ```bash
    sudo dnf install kernel-devel-$(uname -r)
    ```
2.  Пересоберите модуль NVIDIA для всех ядер:
    ```bash
    sudo dkms autoinstall
    ```
3.  Перезагрузите систему.

### Проблема: Конфликт с драйвером `nouveau`

**Причина:** Открытый драйвер `nouveau` не был добавлен в чёрный список и загружается вместе с `nvidia`.

**Решение:**

1.  Создайте файл, чтобы заблокировать `nouveau`:
    ```bash
    echo "blacklist nouveau" | sudo tee /etc/modprobe.d/blacklist-nouveau.conf
    ```
2.  Пересоберите образ initramfs:
    ```bash
    sudo dracut -f
    ```
3.  Перезагрузите систему.

### Проблема: Чёрный экран после установки драйвера

**Причина:** Чаще всего это связано с неправильной конфигурацией Xorg или проблемой с Kernel Mode Setting (KMS).

**Решение:**

1.  **Добавьте параметр в ядро.**
    - Откройте файл `/etc/default/grub` с правами `sudo`.
    - Найдите строку `GRUB_CMDLINE_LINUX` и добавьте в неё `nvidia-drm.modeset=1`.
    - Должно получиться что-то вроде: `GRUB_CMDLINE_LINUX="... quiet splash nvidia-drm.modeset=1"`
2.  **Обновите конфигурацию GRUB.**
    ```bash
    sudo grub2-mkconfig -o /boot/grub2/grub.cfg
    ```
3.  Перезагрузите систему.

### Проблема: Неправильная версия `kernel-devel`

**Причина:** Иногда `dnf` может установить `kernel-devel` последней версии, а не для текущего запущенного ядра, особенно если вы давно не перезагружались после обновления.

**Решение:**

1.  Проверьте версии:
    ```bash
    # Версия запущенного ядра
    uname -r

    # Версия установленных devel-пакетов
    rpm -qa | grep kernel-devel
    ```
2.  Если они не совпадают, установите нужную версию `kernel-devel` (см. первую проблему) и удалите неправильную.
    ```bash
    sudo dnf remove kernel-devel-ВЕРСИЯ
    ```

Если ничего не помогает, попробуйте переустановить драйвер с помощью [kroko-cli](@/docs/02-daily-use/nvidia/02-kroko-cli.md), который решает многие из этих проблем автоматически.
